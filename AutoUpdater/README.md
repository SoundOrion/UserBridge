このプログラムが**正常終了（EXIT_SUCCESS = 0）**したときの「挙動」と「結果」は、具体的に以下のようになります。

## 🧭 全体の流れ（正常経路）

1. **SYSTEM/管理者で実行**

   * 親プロセス (`Main`) が管理者権限または SYSTEM アカウントで起動。
   * 自分自身を「ユーザーのアクティブセッション」で再起動（`--client` オプション付き）。
   * 以降の処理はユーザー権限で行われます。

2. **ユーザー側プロセス (`UserEntryPoint`) 開始**

   * `10分` の watchdog タイマーが起動（ハング・無限ループ対策）。
   * `AutoUpdater.config` をロードして設定内容を取得。

3. **設定検証**

   * `SourceZip`（更新元ZIP）
   * `TargetDir`（更新先ディレクトリ）
   * `ExeNames`（対象実行ファイル名一覧）
     がすべて存在し、正しく指定されているか確認。
     → 不足があれば即終了（EXIT_CONFIG_ERROR）

4. **ミューテックスによる排他**

   * `TargetDir` に基づいて `Global\ZipReplace48_xxx` ミューテックスを作成。
   * 既に他のインスタンスが実行中なら中断（EXIT_SERVICE_UNAVAILABLE）。
   * 問題なければロックを取得。

5. **プロセス稼働チェック**

   * `ExeNames` に該当するプロセスが動作していないことを確認。
   * 実行中なら中断（EXIT_RUNTIME_ERROR）。

6. **更新要否判定**

   * `SourceZip` の更新日時を比較。
   * 条件：

     * 対象フォルダが空である
     * 対象ZIPが存在しない
     * `SourceZip` が対象側より新しい
       のいずれかが真なら「更新すべき」と判断。

7. **更新実行**

   * `ReplaceFolderWithZipSafe()` により以下の処理を安全に実施：

     1. ZIPを一時ディレクトリに展開（Zip Slip防止）
     2. 一時ステージング領域にZIPと展開物を配置
     3. プロセス再チェック
     4. 対象ディレクトリをクリア（古い実行ファイル削除）
     5. 新しい内容をコピー

8. **正常終了**

   * エラーなしで完了した場合：

     * `_exitCode = EXIT_SUCCESS (0)`
     * watchdog解放、ミューテックス解放
     * コンソールまたはログに

       ```
       [2025-10-26T10:00:00Z UTC] 更新完了。
       ```

       のようなログが残る。
   * 親プロセス側でも `ExitCode == 0` を検知して
     「ユーザー側処理 成功」 とログされる。

---

## 🧾 実際に残る結果

### 1. 対象ディレクトリ (`TargetDir`)

* ZIP内のファイル一式が展開され、完全に置き換えられる。
* `SourceZip` 自体のコピーも含まれる（`targetDir\SourceZipName.zip`）。

### 2. ログファイル

* `%BaseDir%\bridgeexec.log` に記録：

  ```
  [2025-10-26T10:00:00.0000000Z UTC] Information: ユーザー側処理 成功
  [2025-10-26T10:00:00.0000000Z UTC] Information: 更新完了
  ```
* イベントログ（Windows の「アプリケーションログ」）にも
  `BridgeExec` ソースで成功メッセージが出力される。

### 3. プロセス状態

* watchdog 解放済み → ハングなし。
* ミューテックス解放済み → 次回実行可能。

---

## ✅ 結果的な意味（運用視点）

このプログラムが正常終了したということは：

| 意味          | 内容                              |
| ----------- | ------------------------------- |
| ✅ 更新チェック成功  | 設定ファイル・ZIP・フォルダがすべて正しく読み取れた     |
| ✅ プロセスロック成功 | 他プロセスとの競合なし                     |
| ✅ 必要に応じて更新  | 新しいZIPで安全に差し替え完了                |
| ✅ エラーなし     | ファイルI/O、権限、例外、ハングなし             |
| ✅ 親プロセスも完了  | SYSTEM側からの呼び出し完遂、ユーザーセッション復帰も成功 |

---

## 💡 まとめ

**正常終了（EXIT_SUCCESS = 0）時の最終状態：**

* `TargetDir` に最新ZIPの内容が完全に展開済み。
* 対象実行ファイルは更新され、古いものは削除済み。
* イベントログおよび `bridgeexec.log` に「成功」メッセージが残る。
* watchdog と mutex は安全に解放。
* 親プロセス（SYSTEM 側）も `ExitCode=0` を受けて成功ログを出す。
